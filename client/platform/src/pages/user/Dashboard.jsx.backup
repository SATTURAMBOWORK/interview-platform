import { useEffect, useState } from "react";
import { useNavigate } from "react-router-dom";
import { motion } from "framer-motion";
import {
  TrendingUp,
  BookOpen,
  Code2,
  Award,
  Zap,
  Calendar,
  Target,
  Trophy,
  Layers,
  Clock,
  Flame,
  Activity,
  Sparkles,
} from "lucide-react";
import api from "../../api/axios";
import SubjectCard from "../../components/user/SubjectCard";

const clampPercent = (value) => Math.min(Math.max(value, 0), 100);
const formatDateKey = (date) => date.toISOString().slice(0, 10);
const getHeatClass = (value, max) => {
  if (!max || value === 0) {
    return "bg-slate-800/50";
  }
  const ratio = value / max;
  if (ratio >= 0.75) return "bg-indigo-500/80";
  if (ratio >= 0.5) return "bg-indigo-500/60";
  if (ratio >= 0.25) return "bg-indigo-500/40";
  return "bg-slate-700/60";
};

function UserDashboard() {
  const navigate = useNavigate();

  const [subjects, setSubjects] = useState([]);
  const [attempts, setAttempts] = useState([]);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [subjectsRes, attemptsRes] = await Promise.all([
          api.get("/subjects"),
          api.get("/attempts/my"),
        ]);

        setSubjects(subjectsRes.data);
        setAttempts(attemptsRes.data);
      } catch (error) {
        console.error("Dashboard load error", error);
      }
    };

    fetchData();
  }, []);

  /* ===================== */
  /* KPI CALCULATIONS */
  /* ===================== */
  const totalAttempts = attempts.length;

  const totalQuestions = attempts.reduce(
    (sum, a) => sum + (a.totalQuestions || 0),
    0
  );

  const averageScore =
    totalAttempts === 0
      ? 0
      : Math.round(
          attempts.reduce((sum, a) => sum + a.score, 0) /
            totalAttempts
        );

  const accuracy =
    totalAttempts === 0
      ? 0
      : Math.round(
          (attempts.reduce(
            (sum, a) => sum + a.correctCount,
            0
          ) /
            attempts.reduce(
              (sum, a) => sum + a.totalQuestions,
              0
            )) *
            100
        );

  const sortedAttempts = [...attempts].sort(
    (a, b) => new Date(b.createdAt) - new Date(a.createdAt)
  );

  const lastAttempt = sortedAttempts[0];
  const lastAttemptScore = lastAttempt?.score ?? 0;
  const lastAttemptAccuracy = lastAttempt
    ? Math.round(
        ((lastAttempt.correctCount || 0) /
          (lastAttempt.totalQuestions || 1)) *
          100
      )
    : 0;

  const attemptsThisWeek = attempts.filter((a) => {
    const created = new Date(a.createdAt).getTime();
    return Date.now() - created <= 7 * 24 * 60 * 60 * 1000;
  }).length;

  const last3 = sortedAttempts.slice(0, 3);
  const prev3 = sortedAttempts.slice(3, 6);
  const last3Avg =
    last3.length === 0
      ? 0
      : Math.round(last3.reduce((s, a) => s + a.score, 0) / last3.length);
  const prev3Avg =
    prev3.length === 0
      ? 0
      : Math.round(prev3.reduce((s, a) => s + a.score, 0) / prev3.length);
  const improvement = prev3Avg === 0 ? 0 : last3Avg - prev3Avg;

  const averagePercent = clampPercent(averageScore);
  const accuracyPercent = clampPercent(accuracy);
  const outerRadius = 54;
  const innerRadius = 40;
  const outerCircumference = 2 * Math.PI * outerRadius;
  const innerCircumference = 2 * Math.PI * innerRadius;
  const outerOffset = outerCircumference * (1 - averagePercent / 100);
  const innerOffset = innerCircumference * (1 - accuracyPercent / 100);

  const attemptsByDate = attempts.reduce((acc, attempt) => {
    if (!attempt.createdAt) return acc;
    const key = formatDateKey(new Date(attempt.createdAt));
    acc[key] = (acc[key] || 0) + (attempt.totalQuestions || 0);
    return acc;
  }, {});

  const heatmapDays = Array.from({ length: 28 }, (_, index) => {
    const date = new Date();
    date.setDate(date.getDate() - (27 - index));
    date.setHours(0, 0, 0, 0);
    return date;
  });

  const heatmapData = heatmapDays.map((date) => {
    const key = formatDateKey(date);
    return {
      key,
      value: attemptsByDate[key] || 0,
      label: date.toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
      }),
    };
  });

  const maxHeatValue = Math.max(0, ...heatmapData.map((d) => d.value));

  const streakDays = (() => {
    if (Object.keys(attemptsByDate).length === 0) return 0;
    let count = 0;
    for (let i = 0; i < 365; i += 1) {
      const date = new Date();
      date.setDate(date.getDate() - i);
      const key = formatDateKey(date);
      if (attemptsByDate[key] && attemptsByDate[key] > 0) {
        count += 1;
      } else {
        break;
      }
    }
    return count;
  })();

  const streakLabel =
    streakDays >= 10
      ? "Top 5% of learners today"
      : streakDays >= 5
      ? "Top 20% this week"
      : "Start your streak today";

  const recentAttempts = sortedAttempts.slice(0, 5);

  /* ===================== */
  /* SUBJECT LEVEL METRICS */
  /* ===================== */
  const getSubjectStats = (subjectId) => {
    const subjectAttempts = attempts.filter((a) => {
      const attemptSubjectId =
        typeof a.subject === "string"
          ? a.subject
          : a.subject?._id;

      return attemptSubjectId === subjectId;
    });

    const attemptsCount = subjectAttempts.length;

    const bestScore =
      attemptsCount === 0
        ? 0
        : Math.max(...subjectAttempts.map((a) => a.score));

    const avgScore =
      attemptsCount === 0
        ? 0
        : Math.round(
            subjectAttempts.reduce(
              (sum, a) => sum + a.score,
              0
            ) / attemptsCount
          );

    return {
      attemptsCount,
      bestScore,
      avgScore,
    };
  };

  const subjectStats = subjects.map((subject) => {
    const stats = getSubjectStats(subject._id);
    return { subject, ...stats };
  });

  const bestSubject = subjectStats
    .filter((s) => s.attemptsCount > 0)
    .sort((a, b) => b.avgScore - a.avgScore)[0];

  const mostAttemptedSubject = subjectStats
    .filter((s) => s.attemptsCount > 0)
    .sort((a, b) => b.attemptsCount - a.attemptsCount)[0];

  const weakestSubject = subjectStats
    .filter((s) => s.attemptsCount > 0)
    .sort((a, b) => a.avgScore - b.avgScore)[0];

  const containerVariants = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        staggerChildren: 0.1,
        delayChildren: 0.2,
      },
    },
  };

  const itemVariants = {
    hidden: { opacity: 0, y: 10, filter: "blur(4px)" },
    visible: {
      opacity: 1,
      y: 0,
      filter: "blur(0px)",
      transition: { type: "spring", stiffness: 120, damping: 18 },
    },
  };

  const handleSpotlightMove = (event) => {
    const rect = event.currentTarget.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;
    event.currentTarget.style.setProperty("--mouse-x", `${x}px`);
    event.currentTarget.style.setProperty("--mouse-y", `${y}px`);
  };

  const handleSpotlightLeave = (event) => {
    event.currentTarget.style.setProperty("--mouse-x", "50%");
    event.currentTarget.style.setProperty("--mouse-y", "50%");
  };

  return (
    <div
      className="min-h-screen bg-[#0a0a0a] text-slate-300"
      style={{ fontFamily: "var(--font-body)" }}
    >
      <div className="fixed inset-0 -z-20 bg-[#0a0a0a]"></div>

      <div className="max-w-[1300px] mx-auto px-4 md:px-8 py-10 space-y-8">

        {/* ===================== */}
        {/* HERO SECTION - COMPACT STATS ROW */}
        {/* ===================== */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.4 }}
            className="bg-[#1a1a1a] border border-[#333] rounded-lg p-5 md:p-6"
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Total Solved</p>
                <p className="text-3xl font-bold text-slate-100">{totalQuestions}</p>
                <p className="text-xs text-slate-500 mt-1">{totalAttempts} attempts</p>
              </div>
              <div className="p-3 bg-[#262626] rounded border border-[#333]">
                <Award className="w-5 h-5 text-slate-400" />
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.4, delay: 0.1 }}
            className="bg-[#1a1a1a] border border-[#333] rounded-lg p-5 md:p-6"
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Avg Score</p>
                <p className="text-3xl font-bold text-slate-100">{averageScore}%</p>
                <p className="text-xs text-slate-500 mt-1">Accuracy {accuracy}%</p>
              </div>
              <div className="p-3 bg-[#262626] rounded border border-[#333]">
                <TrendingUp className="w-5 h-5 text-slate-400" />
              </div>
            </div>
          </motion.div>

          <motion.div
            initial={{ opacity: 0, y: 10 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ duration: 0.4, delay: 0.2 }}
            className="bg-[#1a1a1a] border border-[#333] rounded-lg p-5 md:p-6"
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-xs font-medium text-slate-500 uppercase tracking-wider mb-2">Daily Streak</p>
                <div className="flex items-baseline gap-2">
                  <p className="text-3xl font-bold text-slate-100">{streakDays}</p>
                  <p className="text-xs text-amber-400 font-mono">days</p>
                </div>
                <p className="text-xs text-slate-500 mt-1">{streakLabel}</p>
              </div>
              <div className="p-3 bg-[#262626] rounded border border-[#333]">
                <Flame className="w-5 h-5 text-amber-400" />
              </div>
            </div>
          </motion.div>
        </div>

        {/* ===================== */}
        {/* CURRENT STATS */}
        {/* ===================== */}
        <motion.section
          variants={itemVariants}
          initial="hidden"
          animate="visible"
          transition={{ delay: 0.3 }}
          className="space-y-6"
        >
          <div className="flex items-center gap-3">
            <div className="p-2 bg-slate-900/70 rounded-lg border border-white/10">
              <Target className="w-5 h-5 text-indigo-300" />
            </div>
            <h3
              className="text-2xl font-bold text-slate-100"
              style={{ fontFamily: "var(--font-display)" }}
            >
              Current Stats
            </h3>
          </div>

          <div className="grid grid-cols-1 gap-4">
            <motion.div
              variants={itemVariants}
              onMouseMove={handleSpotlightMove}
              onMouseLeave={handleSpotlightLeave}
              style={{ "--mouse-x": "50%", "--mouse-y": "50%" }}
              className="group relative overflow-hidden rounded-[28px] border border-white/5 bg-slate-900/50 backdrop-blur shadow-[0_8px_24px_rgba(0,0,0,0.35)] p-4"
            >
              <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-[radial-gradient(circle_at_var(--mouse-x)_var(--mouse-y),rgba(99,102,241,0.16),transparent_55%)]"></div>
              <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                <div className="absolute inset-[-1px] bg-gradient-to-r from-transparent via-indigo-500/35 to-transparent blur-sm" />
              </div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <StatChip
                  label="Tests Taken"
                  value={totalAttempts}
                  icon={Award}
                  onSpotlightMove={handleSpotlightMove}
                  onSpotlightLeave={handleSpotlightLeave}
                />
                <StatChip
                  label="Questions Solved"
                  value={totalQuestions}
                  icon={Layers}
                  onSpotlightMove={handleSpotlightMove}
                  onSpotlightLeave={handleSpotlightLeave}
                />
                <StatChip
                  label="This Week"
                  value={attemptsThisWeek}
                  icon={Calendar}
                  onSpotlightMove={handleSpotlightMove}
                  onSpotlightLeave={handleSpotlightLeave}
                />
              </div>
            </motion.div>

            <div className="grid lg:grid-cols-12 gap-4">
              <motion.div
                variants={itemVariants}
                onMouseMove={handleSpotlightMove}
                onMouseLeave={handleSpotlightLeave}
                style={{ "--mouse-x": "50%", "--mouse-y": "50%" }}
                className="group lg:col-span-6 relative overflow-hidden rounded-[32px] border border-white/5 bg-slate-900/50 backdrop-blur shadow-[0_10px_28px_rgba(0,0,0,0.4)]"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-[radial-gradient(circle_at_var(--mouse-x)_var(--mouse-y),rgba(99,102,241,0.18),transparent_55%)]"></div>
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <div className="absolute inset-[-1px] bg-gradient-to-r from-transparent via-indigo-500/40 to-transparent blur-sm" />
                </div>
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(148,163,184,0.08),transparent_60%)]"></div>
                <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(79,70,229,0.22),transparent_55%)]"></div>

                <div className="relative p-7 md:p-9 space-y-6">
                  <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                    <div className="space-y-2">
                      <p className="text-xs font-semibold uppercase tracking-[0.25em] text-amber-400">
                        Momentum Index
                      </p>
                      <h4
                        className="text-3xl md:text-4xl font-bold text-slate-100"
                        style={{ fontFamily: "var(--font-display)" }}
                      >
                        A premium snapshot of your prep
                      </h4>
                      <p className="text-slate-300 max-w-md">
                        Your average score and accuracy create a live signal of how consistent your practice is right now.
                      </p>
                    </div>

                    <div className="relative w-44 h-44 shrink-0">
                      <svg
                        className="w-full h-full -rotate-90"
                        viewBox="0 0 120 120"
                      >
                        <defs>
                          <linearGradient
                            id="scoreGradient"
                            x1="0%"
                            y1="0%"
                            x2="100%"
                            y2="0%"
                          >
                            <stop offset="0%" stopColor="#6366F1" />
                            <stop offset="100%" stopColor="#06B6D4" />
                          </linearGradient>
                          <linearGradient
                            id="accuracyGradient"
                            x1="0%"
                            y1="0%"
                            x2="100%"
                            y2="0%"
                          >
                            <stop offset="0%" stopColor="#10B981" />
                            <stop offset="100%" stopColor="#34D399" />
                          </linearGradient>
                        </defs>
                        <circle
                          cx="60"
                          cy="60"
                          r={outerRadius}
                          stroke="#111827"
                          strokeWidth="8"
                          fill="transparent"
                        />
                        <circle
                          cx="60"
                          cy="60"
                          r={outerRadius}
                          stroke="url(#scoreGradient)"
                          strokeWidth="8"
                          strokeLinecap="round"
                          strokeDasharray={outerCircumference}
                          strokeDashoffset={outerOffset}
                          fill="transparent"
                          style={{
                            filter:
                              "drop-shadow(0 0 12px rgba(99,102,241,0.5))",
                          }}
                        />
                        <circle
                          cx="60"
                          cy="60"
                          r={innerRadius}
                          stroke="#111827"
                          strokeWidth="5"
                          fill="transparent"
                        />
                        <circle
                          cx="60"
                          cy="60"
                          r={innerRadius}
                          stroke="url(#accuracyGradient)"
                          strokeWidth="6"
                          strokeLinecap="round"
                          strokeDasharray={innerCircumference}
                          strokeDashoffset={innerOffset}
                          fill="transparent"
                          style={{
                            filter:
                              "drop-shadow(0 0 10px rgba(16,185,129,0.4))",
                          }}
                        />
                      </svg>
                      <div className="absolute inset-7 rounded-full bg-slate-900/80 border border-white/5 shadow-[0_8px_20px_rgba(0,0,0,0.4)] flex flex-col items-center justify-center text-center">
                        <p className="text-xs uppercase tracking-[0.25em] text-slate-400">Avg</p>
                        <p className="text-2xl font-bold text-slate-100">
                          {averageScore}%
                        </p>
                        <p className="text-xs text-slate-400">
                          Accuracy {accuracy}%
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="flex flex-wrap items-center gap-3 text-xs text-slate-400">
                    <span className="inline-flex items-center gap-2 rounded-full border border-white/5 bg-slate-900/70 px-3 py-1">
                      <span className="w-2 h-2 rounded-full bg-indigo-500"></span>
                      Avg score {averageScore}%
                    </span>
                    <span className="inline-flex items-center gap-2 rounded-full border border-white/5 bg-slate-900/70 px-3 py-1">
                      <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
                      Accuracy {accuracy}%
                    </span>
                  </div>
                </div>
              </motion.div>

              <motion.div
                variants={itemVariants}
                onMouseMove={handleSpotlightMove}
                onMouseLeave={handleSpotlightLeave}
                style={{ "--mouse-x": "50%", "--mouse-y": "50%" }}
                className="group lg:col-span-6 relative overflow-hidden rounded-[32px] border border-white/5 bg-slate-900/50 backdrop-blur shadow-[0_10px_28px_rgba(0,0,0,0.4)]"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-[radial-gradient(circle_at_var(--mouse-x)_var(--mouse-y),rgba(16,185,129,0.16),transparent_55%)]"></div>
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <div className="absolute inset-[-1px] bg-gradient-to-r from-transparent via-emerald-500/40 to-transparent blur-sm" />
                </div>
                <div className="relative p-7 md:p-9 space-y-5">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                        Recent Activity
                      </p>
                      <p className="text-lg font-semibold text-slate-100 mt-2">
                        Your latest practice sessions
                      </p>
                    </div>
                    <div className="w-10 h-10 rounded-2xl bg-slate-800 border border-white/5 flex items-center justify-center">
                      <Activity className="w-5 h-5 text-emerald-300" />
                    </div>
                  </div>

                  {recentAttempts.length === 0 ? (
                    <div className="flex items-center justify-center h-40 rounded-2xl border border-white/5 bg-slate-900/70 text-slate-400">
                      No attempts yet
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {recentAttempts.map((attempt) => {
                        const subjectName =
                          typeof attempt.subject === "string"
                            ? "Subject"
                            : attempt.subject?.name || "Subject";
                        const attemptAccuracy = Math.round(
                          ((attempt.correctCount || 0) /
                            (attempt.totalQuestions || 1)) *
                            100
                        );
                        return (
                          <div
                            key={attempt._id}
                            className="flex items-center justify-between rounded-2xl border border-white/5 bg-slate-900/70 px-4 py-3"
                          >
                            <div>
                              <p className="text-sm font-semibold text-slate-100">
                                {subjectName}
                              </p>
                              <p className="text-xs text-slate-400">
                                {attempt.createdAt
                                  ? new Date(attempt.createdAt).toLocaleDateString()
                                  : "—"}
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="text-sm font-semibold text-slate-100">
                                {attempt.score}%
                              </p>
                              <p className="text-xs text-slate-400">
                                {attemptAccuracy}% accuracy
                              </p>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </motion.div>
            </div>

            <div className="grid lg:grid-cols-12 gap-4">
              <motion.div
                variants={itemVariants}
                onMouseMove={handleSpotlightMove}
                onMouseLeave={handleSpotlightLeave}
                style={{ "--mouse-x": "50%", "--mouse-y": "50%" }}
                className="group lg:col-span-7 relative overflow-hidden rounded-[32px] border border-white/5 bg-slate-900/50 backdrop-blur shadow-[0_10px_28px_rgba(0,0,0,0.4)]"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-[radial-gradient(circle_at_var(--mouse-x)_var(--mouse-y),rgba(99,102,241,0.16),transparent_55%)]"></div>
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <div className="absolute inset-[-1px] bg-gradient-to-r from-transparent via-indigo-500/40 to-transparent blur-sm" />
                </div>
                <div className="relative p-7 md:p-9 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                        Topic Heatmap
                      </p>
                      <p className="text-lg font-semibold text-slate-100 mt-2">
                        Questions solved in the last 28 days
                      </p>
                    </div>
                    <div className="w-10 h-10 rounded-2xl bg-slate-800 border border-white/5 flex items-center justify-center">
                      <Sparkles className="w-5 h-5 text-indigo-300" />
                    </div>
                  </div>

                  <div className="grid grid-cols-7 gap-2">
                    {heatmapData.map((day) => (
                      <div
                        key={day.key}
                        className={`h-7 rounded-lg ${getHeatClass(
                          day.value,
                          maxHeatValue
                        )}`}
                        title={`${day.label}: ${day.value} questions`}
                      ></div>
                    ))}
                  </div>

                  <div className="flex items-center justify-between text-xs text-slate-400">
                    <span>Less</span>
                    <div className="flex items-center gap-1">
                      <span className="w-4 h-2 rounded bg-slate-800/60"></span>
                      <span className="w-4 h-2 rounded bg-indigo-500/30"></span>
                      <span className="w-4 h-2 rounded bg-indigo-500/60"></span>
                      <span className="w-4 h-2 rounded bg-indigo-500/90"></span>
                    </div>
                    <span>More</span>
                  </div>
                </div>
              </motion.div>

              <motion.div
                variants={itemVariants}
                onMouseMove={handleSpotlightMove}
                onMouseLeave={handleSpotlightLeave}
                style={{ "--mouse-x": "50%", "--mouse-y": "50%" }}
                className="group lg:col-span-5 relative overflow-hidden rounded-[32px] border border-white/5 bg-slate-900/50 backdrop-blur shadow-[0_10px_28px_rgba(0,0,0,0.4)]"
              >
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500 bg-[radial-gradient(circle_at_var(--mouse-x)_var(--mouse-y),rgba(245,158,11,0.18),transparent_55%)]"></div>
                <div className="absolute inset-0 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <div className="absolute inset-[-1px] bg-gradient-to-r from-transparent via-amber-500/40 to-transparent blur-sm" />
                </div>
                <div className="relative p-7 md:p-9 space-y-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-xs font-semibold uppercase tracking-[0.25em] text-slate-400">
                        AI Priority
                      </p>
                      <p className="text-lg font-semibold text-slate-100 mt-2">
                        Smart preparation focus
                      </p>
                    </div>
                    <div className="w-10 h-10 rounded-2xl bg-slate-800 border border-white/5 flex items-center justify-center">
                      <Target className="w-5 h-5 text-amber-300" />
                    </div>
                  </div>

                  {weakestSubject ? (
                    <div className="space-y-3">
                      <p className="text-slate-300">
                        Your {weakestSubject.subject?.name} average is {weakestSubject.avgScore}%.
                      </p>
                      <p className="text-sm text-slate-400">
                        Focus here to lift your overall momentum and unlock the next performance tier.
                      </p>
                      <button
                        type="button"
                        onClick={() =>
                          navigate(
                            `/dashboard/subject/${weakestSubject.subject?._id}`
                          )
                        }
                        className="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-amber-500/90 text-slate-950 font-semibold text-sm shadow-[0_10px_20px_rgba(0,0,0,0.35)]"
                      >
                        Review weak area
                        <TrendingUp className="w-4 h-4" />
                      </button>
                    </div>
                  ) : (
                    <p className="text-slate-400">
                      Start practicing to unlock personalized recommendations.
                    </p>
                  )}
                </div>
              </motion.div>
            </div>

            <div className="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <StatTile
                title="Best Subject"
                value={bestSubject?.subject?.name || "—"}
                subtitle={
                  bestSubject?.avgScore
                    ? `${bestSubject.avgScore}% avg`
                    : "No attempts yet"
                }
                icon={Trophy}
                tone="violet"
                onSpotlightMove={handleSpotlightMove}
                onSpotlightLeave={handleSpotlightLeave}
              />
              <StatTile
                title="Most Practiced"
                value={mostAttemptedSubject?.subject?.name || "—"}
                subtitle={
                  mostAttemptedSubject?.attemptsCount
                    ? `${mostAttemptedSubject.attemptsCount} attempts`
                    : "No attempts yet"
                }
                icon={BookOpen}
                tone="indigo"
                onSpotlightMove={handleSpotlightMove}
                onSpotlightLeave={handleSpotlightLeave}
              />
              <StatTile
                title="Last Attempt"
                value={`${lastAttemptScore}%`}
                subtitle={`${lastAttemptAccuracy}% accuracy`}
                icon={Clock}
                tone="amber"
                onSpotlightMove={handleSpotlightMove}
                onSpotlightLeave={handleSpotlightLeave}
              />
              <StatTile
                title="Recent Trend"
                value={
                  improvement > 0
                    ? `+${improvement}%`
                    : improvement < 0
                    ? `${improvement}%`
                    : "0%"
                }
                subtitle="Last 3 vs previous 3"
                icon={TrendingUp}
                tone="rose"
                onSpotlightMove={handleSpotlightMove}
                onSpotlightLeave={handleSpotlightLeave}
              />
            </div>
          </div>
        </motion.section>


        {/* ===================== */}
        {/* CORE SUBJECTS */}
        {/* ===================== */}
        <motion.section
          variants={itemVariants}
          initial="hidden"
          animate="visible"
          transition={{ delay: 0.5 }}
          className="space-y-6"
        >
          <div className="flex items-center gap-3">
            <div className="p-2 bg-slate-900/70 rounded-lg border border-white/10">
              <BookOpen className="w-5 h-5 text-slate-200" />
            </div>
            <h3
              className="text-2xl font-bold text-slate-100"
              style={{ fontFamily: "var(--font-display)" }}
            >
              Core Subjects (MCQs)
            </h3>
          </div>

          {subjects.length === 0 ? (
            <motion.div
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              className="flex items-center justify-center min-h-[300px]"
            >
              <p className="text-slate-400 text-lg">
                No subjects available yet
              </p>
            </motion.div>
          ) : (
            <motion.div
              variants={containerVariants}
              initial="hidden"
              animate="visible"
              className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
            >
              {subjects.map((subject) => (
                <motion.div key={subject._id} variants={itemVariants}>
                  <SubjectCard subject={subject} />
                </motion.div>
              ))}
            </motion.div>
          )}
        </motion.section>

        {/* ===================== */}
        {/* DSA PREMIUM MODULE */}
        {/* ===================== */}
        <motion.section
          variants={itemVariants}
          initial="hidden"
          animate="visible"
          transition={{ delay: 0.7 }}
          className="space-y-6"
        >
          <div className="flex items-center gap-3">
            <div className="p-2 bg-slate-900/70 rounded-lg border border-white/10">
              <Code2 className="w-5 h-5 text-slate-200" />
            </div>
            <h3
              className="text-2xl font-bold text-slate-100"
              style={{ fontFamily: "var(--font-display)" }}
            >
              Data Structures & Algorithms
            </h3>
          </div>

          <motion.div
            whileHover={{
              y: -5,
              scale: 1.01,
              borderColor: "rgba(99, 102, 241, 0.4)",
            }}
            onClick={() => navigate("/dsa")}
            className="cursor-pointer relative group overflow-hidden rounded-[32px] border border-white/10"
          >
            {/* Background gradient */}
            <div className="absolute inset-0 bg-gradient-to-r from-slate-950 via-slate-900 to-indigo-950"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(255,255,255,0.18),transparent_60%)]"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(99,102,241,0.18),transparent_55%)]"></div>

            {/* Content */}
            <div className="relative p-9 md:p-12 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-8 border border-white/10 shadow-[0_8px_24px_rgba(0,0,0,0.5)] rounded-[32px]">
              <div className="space-y-4 flex-1">
                <h4
                  className="text-3xl md:text-4xl font-bold tracking-tight"
                  style={{ fontFamily: "var(--font-display)" }}
                >
                  Master DSA for Interviews
                </h4>
                <p className="text-indigo-100/70 text-lg max-w-xl leading-relaxed">
                  Practice coding problems, strengthen problem-solving skills, and prepare for real interview scenarios with our comprehensive DSA module.
                </p>
                <div className="flex flex-wrap gap-2 pt-1">
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    Curated problem sets
                  </span>
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    Difficulty‑wise practice
                  </span>
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    Interview ready
                  </span>
                </div>
              </div>

              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="group/btn px-8 py-4 bg-white text-slate-900 rounded-xl font-bold text-lg shadow-[0_12px_28px_rgba(0,0,0,0.45)] hover:shadow-[0_16px_34px_rgba(0,0,0,0.55)] hover:bg-slate-50 transition-all duration-300 flex items-center gap-2 whitespace-nowrap"
              >
                Start Practicing
                <motion.span
                  animate={{ x: [0, 4, 0] }}
                  transition={{ duration: 1.5, repeat: Infinity }}
                >
                  →
                </motion.span>
              </motion.button>
            </div>
          </motion.div>
        </motion.section>

        {/* ===================== */}
        {/* STAR INTERVIEW PRACTICE */}
        {/* ===================== */}
        <motion.section
          variants={itemVariants}
          initial="hidden"
          animate="visible"
          transition={{ delay: 0.8 }}
          className="space-y-6"
        >
          <div className="flex items-center gap-3">
            <div className="p-2 bg-slate-900/70 rounded-lg border border-white/10">
              <Award className="w-5 h-5 text-slate-200" />
            </div>
            <h3
              className="text-2xl font-bold text-slate-100"
              style={{ fontFamily: "var(--font-display)" }}
            >
              STAR Interview Practice
            </h3>
          </div>

          <motion.div
            whileHover={{
              y: -5,
              scale: 1.01,
              borderColor: "rgba(79, 70, 229, 0.4)",
            }}
            onClick={() => navigate("/star-interview")}
            className="cursor-pointer relative group overflow-hidden rounded-[32px] border border-white/10"
          >
            {/* Background gradient */}
            <div className="absolute inset-0 bg-gradient-to-r from-slate-950 via-slate-900 to-indigo-950"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_top_left,rgba(255,255,255,0.18),transparent_60%)]"></div>
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,rgba(79,70,229,0.18),transparent_55%)]"></div>

            {/* Content */}
            <div className="relative p-9 md:p-12 text-white flex flex-col md:flex-row justify-between items-start md:items-center gap-8 border border-white/10 shadow-[0_8px_24px_rgba(0,0,0,0.5)] rounded-[32px]">
              <div className="space-y-4 flex-1">
                <h4
                  className="text-3xl md:text-4xl font-bold tracking-tight"
                  style={{ fontFamily: "var(--font-display)" }}
                >
                  Master Behavioral Interviews
                </h4>
                <p className="text-indigo-100/70 text-lg max-w-xl leading-relaxed">
                  Practice STAR-based behavioral questions with AI-powered feedback. Improve clarity, impact, and demonstrate your best self to interviewers.
                </p>
                <div className="flex flex-wrap gap-2 pt-1">
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    56+ questions
                  </span>
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    AI analysis
                  </span>
                  <span className="px-3 py-1 rounded-full bg-white/10 border border-white/10 text-xs font-semibold">
                    Category-wise
                  </span>
                </div>
              </div>

              <motion.button
                whileHover={{ scale: 1.05 }}
                whileTap={{ scale: 0.95 }}
                className="group/btn px-8 py-4 bg-white text-slate-900 rounded-xl font-bold text-lg shadow-[0_12px_28px_rgba(0,0,0,0.45)] hover:shadow-[0_16px_34px_rgba(0,0,0,0.55)] hover:bg-slate-50 transition-all duration-300 flex items-center gap-2 whitespace-nowrap"
              >
                Start Interview Practice
                <motion.span
                  animate={{ x: [0, 4, 0] }}
                  transition={{ duration: 1.5, repeat: Infinity }}
                >
                  →
                </motion.span>
              </motion.button>
            </div>
          </motion.div>
        </motion.section>

      </div>
    </div>
  );
}

/* ===================== */
/* SIMPLIFIED COMPONENTS */
/* ===================== */
const StatTile = ({ title, value, subtitle, icon: Icon }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 5 }}
      animate={{ opacity: 1, y: 0 }}
      whileHover={{ y: -2, backgroundColor: "#262626" }}
      className="bg-[#1a1a1a] border border-[#333] rounded-lg p-4 transition-colors group"
    >
      <div className="flex items-start justify-between gap-2 mb-3">
        <p className="text-[10px] font-medium uppercase tracking-wider text-slate-500">
          {title}
        </p>
        <div className="p-2 bg-[#262626] rounded border border-[#333] group-hover:text-indigo-400 transition-colors">
          <Icon className="w-3.5 h-3.5 text-slate-500" />
        </div>
      </div>
      <div>
        <p className="text-xl font-bold text-slate-100 leading-tight">{value}</p>
        <p className="text-[10px] text-slate-500 mt-1 font-mono">{subtitle}</p>
      </div>
    </motion.div>
  );
};

export default UserDashboard;